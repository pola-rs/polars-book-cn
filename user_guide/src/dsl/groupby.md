# GroupBy

> æœ¬é¡µè¿˜åœ¨æ–½å·¥ä¸­ã€‚ã€‚ã€‚ã€‚

## å¤šçº¿ç¨‹

å¤„ç†è¡¨çŠ¶æ•°æ®æœ€é«˜æ•ˆçš„æ–¹å¼å°±æ˜¯é€šè¿‡â€œåˆ†å‰²-å¤„ç†-ç»„åˆâ€çš„æ–¹å¼å¹¶è¡Œåœ°è¿›è¡Œã€‚è¿™æ ·çš„æ“ä½œæ­£æ˜¯ `Polars` çš„
åˆ†ç»„æ“ä½œçš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯ `Polars` å¦‚æ­¤é«˜æ•ˆçš„ç§˜å¯†ã€‚ç‰¹åˆ«æŒ‡å‡ºï¼Œåˆ†å‰²å’Œå¤„ç†éƒ½æ˜¯å¤šçº¿ç¨‹æ‰§è¡Œçš„ã€‚

ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†åˆ†ç»„æ“ä½œçš„æµç¨‹ï¼š

![](https://raw.githubusercontent.com/pola-rs/polars-static/master/docs/split-apply-combine.svg)

å¯¹äºåˆ†å‰²é˜¶æ®µçš„å“ˆå¸Œæ“ä½œï¼Œ`Polars` ä½¿ç”¨äº†æ— é”å¤šçº¿ç¨‹æ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://raw.githubusercontent.com/pola-rs/polars-static/master/docs/lock-free-hash.svg)

è¿™æ ·çš„å¹¶è¡Œæ“ä½œå¯ä»¥è®©åˆ†ç»„å’Œè”åˆæ“ä½œéå¸¸éå¸¸é«˜æ•ˆã€‚

> æ›´å¤šè§£é‡Šå‚è€ƒ [è¿™ç¯‡åšå®¢](https://www.ritchievink.com/blog/2021/02/28/i-wrote-one-of-the-fastest-dataframe-libraries/)

## ä¸è¦â€œæ€æ­»â€å¹¶è¡Œ

ä¼—æ‰€å‘¨çŸ¥ï¼Œ`Python` æ…¢ã€æ°´å¹³æ‹“å±•ä¸å¥½ã€‚é™¤äº†å› ä¸ºæ˜¯è§£é‡Šå‹è¯­è¨€ï¼ŒPython è¿˜æ”¶åˆ°å…¨å±€è§£é‡Šå™¨é”ï¼ŒGILã€‚
è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ ä¼ å…¥ä¸€ä¸ª `lambda` æˆ–è€… `Python` è‡ªå®šä¹‰å‡½æ•°ï¼Œ`Polars` é€Ÿåº¦ä¼šè¢«é™åˆ¶ï¼Œå³
æ— æ³•ä½¿ç”¨å¤šæ ¸è¿›è¡Œå¹¶è¡Œè®¡ç®—ã€‚

è¿™æ˜¯ä¸ªå¾ˆç³Ÿç³•çš„æƒ…å†µï¼Œç‰¹åˆ«æˆ‘ä»¬åœ¨åš `.groupby` çš„æ—¶å€™ä¼šç»å¸¸ä¼ å…¥ `lambda` å‡½æ•°ã€‚è™½ç„¶ `Polars`
æ”¯æŒè¿™ç§æ“ä½œï¼Œä½†æ˜¯è¯·æ³¨æ„ Python çš„é™åˆ¶ï¼Œç‰¹åˆ«æ˜¯è§£é‡Šå™¨å’ŒGILã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ`Polars` å®ç°äº†ä¸€ç§éå¸¸å¼ºå¤§çš„è¯­æ³•ï¼Œä¸ä»…å¯ä»¥ç”¨åœ¨æƒ°æ€§APIï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨é¥¥é¥¿APIã€‚

## Polars Expressions

åˆšæ‰æˆ‘ä»¬æåˆ°è‡ªå®šä¹‰ Python å‡½æ•°ä¼šæŸä¼¤å¹¶è¡Œèƒ½åŠ›ï¼Œ`Polars` æä¾›äº†æƒ°æ€§ API æ¥åº”å¯¹è¿™ç§æƒ…å†µã€‚æ¥ä¸‹æ¥
æˆ‘ä»¬çœ‹çœ‹è¿™æ˜¯ä»€ä¹ˆæ„æ€ã€‚

æˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªæ•°æ®é›†å¼€å§‹ï¼š[US congress dataset](https://github.com/unitedstates/congress-legislators).

```python
{{#include ../examples/groupby_dsl/snippet1.py}}
```

#### åŸºæœ¬èšåˆæ“ä½œ

ä½ å¯ä»¥è½»æ¾åœ°æŠŠå¤šä¸ªèšåˆè¡¨è¾¾å¼æ”¾åœ¨ä¸€ä¸ª `list` é‡Œé¢ï¼Œå¹¶æ²¡æœ‰é•¿åº¦é™åˆ¶ï¼Œä½ æ”¾å…¥ä»»ä½•æ•°é‡çš„è¡¨è¾¾å¼ã€‚
ä¸‹é¢è¿™æ®µä»£ç ä¸­æˆ‘ä»¬åšå¦‚ä¸‹èšåˆæ“ä½œï¼š

å¯¹äºæ¯ä¸€ä¸ª `first_name` åˆ†ç»„ï¼š

- ç»Ÿè®¡æ¯ç»„çš„è¡Œæ•°ï¼š
  - çŸ­ç‰ˆï¼š`pl.count("party")`
  - é•¿ç‰ˆï¼š`pl.col("party").count()`
- æŠŠæ¯ç»„çš„æ€§åˆ«æ”¾å…¥ä¸€ä¸ªåˆ—è¡¨:
  - é•¿ç‰ˆï¼š `pl.col("gender").list()`
- æ‰¾åˆ°æ¯ç»„çš„ç¬¬ä¸€ä¸ª `last_name`ï¼š
  - çŸ­ç‰ˆ: `pl.first("last_name")`
  - é•¿ç‰ˆ: `pl.col("last_name").first()`

Besides the aggregation, we immediately sort the result and limit to the top `5` so that
we have a nice summary overview.

```python
{{#include ../examples/groupby_dsl/snippet1.py}}
```

```text
{{#include ../outputs/groupby_dsl/output1.txt}}
```

#### æ¡ä»¶

ç®€å•å§ï¼æˆ‘ä»¬åŠ ç‚¹æ–™ï¼å‡è®¾æˆ‘ä»¬æƒ³è¦çŸ¥é“å¯¹äºæ¯ä¸ª `state` æœ‰å¤šå°‘ `Pro` å’Œ `Anti`ã€‚æˆ‘ä»¬å¯ä»¥
ä¸ç”¨ `lambda` è€Œç›´æ¥æŸ¥è¯¢ã€‚

```python
{{#include ../examples/groupby_dsl/snippet2.py}}
```

```text
{{#include ../outputs/groupby_dsl/output2.txt}}
```

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šå±‚èšåˆå®ç°ï¼Œä½†æ˜¯è¿™ä¸åˆ©äºæˆ‘æ˜¾æ‘†è¿™äº›å¾ˆé…·çš„ç‰¹å¾ğŸ˜‰ï¼

```python
{{#include ../examples/groupby_dsl/snippet3.py}}
```

```text
{{#include ../outputs/groupby_dsl/output3.txt}}
```

#### è¿‡æ»¤

æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿‡æ»¤åˆ†ç»„ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦è®¡ç®—æ¯ç»„çš„å‡å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›è®¡ç®—æ‰€æœ‰å€¼çš„å‡å€¼ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›ç›´æ¥
ä» `DataFrame` è¿‡æ»¤ï¼Œå› ä¸ºæˆ‘ä»¬åéœ€è¿˜éœ€è¦å“ªäº›è¡Œåšå…¶ä»–æ“ä½œã€‚

ä¸‹é¢çš„ä¾‹å­è¯´æ˜æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥å†™æ˜ `Python` çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°æ²¡æœ‰ä»€ä¹ˆ
è¿è¡Œæ—¶å¼€é”€ã€‚å› ä¸ºè¿™äº›å‡½æ•°è¿”å›äº† `Polars` è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¹¶æ²¡åœ¨è¿è¡Œæ—¶è®© `Series` è°ƒç”¨è‡ªåŠ¨å‡½æ•°ã€‚

```python
{{#include ../examples/groupby_dsl/snippet4.py}}
```

```text
{{#include ../outputs/groupby_dsl/output4.txt}}
```

#### æ’åº

æˆ‘ä»¬ç»å¸¸æŠŠä¸€ä¸ª `DataFrame` æ’åºä¸ºäº†åœ¨åˆ†ç»„æ“ä½œçš„æ—¶å€™ä¿æŒæŸç§é¡ºåºã€‚å‡è®¾æˆ‘ä»¬æˆ‘ä»¬å¸Œæœ›çŸ¥é“
æ¯ä¸ª `state` æ”¿æ²»å®¶çš„åå­—ï¼Œå¹¶æŒ‰ç…§å¹´é¾„æ’åºã€‚æˆ‘ä»¬å¯ä»¥ç”¨ `sort` å’Œ `groupby`ï¼š

```python
{{#include ../examples/groupby_dsl/snippet5.py}}
```

```text
{{#include ../outputs/groupby_dsl/output5.txt}}
```

ä½†æ˜¯ï¼Œ**å¦‚æœ**æˆ‘ä»¬æƒ³æŠŠåå­—ä¹ŸæŒ‰ç…§å­—æ¯æ’åºï¼Œä¸Šé¢çš„ä»£ç å°±ä¸è¡Œäº†ã€‚
å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `groupby` ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œæ’åºï¼Œä¸ `DataFrame` æ— å…³ã€‚

```python
{{#include ../examples/groupby_dsl/snippet6.py}}
```

```text
{{#include ../outputs/groupby_dsl/output6.txt}}
```

æˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨ `groupby` ä¸Šä¸‹æ–‡ä¸­å¢åŠ å¦ä¸€ä¸ªåˆ—ï¼Œå¹¶ä¸”æŒ‰ç…§ç”·å¥³æ’åºï¼š
`pl.col("gender").sort_by("first_name").first().alias("gender")`

```python
{{#include ../examples/groupby_dsl/snippet7.py}}
```

```text
{{#include ../outputs/groupby_dsl/output7.txt}}
```

### ç»“è®º

ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬çŸ¥é“é€šè¿‡ç»„åˆè¡¨è¾¾å¼å¯ä»¥å®Œæˆå¤æ‚çš„æŸ¥è¯¢ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬é¿å…äº†ä½¿ç”¨è‡ªå®šä¹‰ `Python` å‡½æ•°
å¸¦æ¥çš„æ€§èƒ½æŸå¤± ï¼ˆè§£é‡Šå™¨å’Œ GILï¼‰ã€‚

å¦‚æœè¿™é‡Œå°‘äº†å“ªç±»è¡¨è¾¾å¼ï¼Œæ¸…åœ¨è¿™é‡Œå¼€ä¸€ä¸ª Issueï¼š
[feature request](https://github.com/pola-rs/polars/issues/new/choose)!
